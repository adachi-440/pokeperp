# オンチェーンCLOB Perp MVP - 実装タスク一覧

## 概要
spec_mini_mvp.mdに基づいたオンチェーンCLOB（中央指値注文板）Perpの最小実装版の開発タスクリストです。Foundryフレームワークを使用してSolidityで実装します。

## 背景
### 目的
- 既存仕様（spec.md）に準拠したMVPの迅速な実装
- 単一マーケット、線形Perp、USDC担保の板取引システム
- オンチェーンでの板管理と約定実行

### 主要な技術的課題
- DoS攻撃への耐性（stepsMaxによる段階的約定）
- ガス効率の最適化（O(1)に近い操作）
- 価格操作の防止（deviationLimitによるバンドチェック）
- FIFO原則の維持（price-time優先）

## 実装タスク

### フェーズ1: 基盤構築

#### タスク1: プロジェクト構成とFoundryセットアップの確認
**背景**: 開発環境の準備
**問題点**: 適切な構成がないと開発効率が低下
**提案**: Foundryベースの標準的なプロジェクト構成を採用
**期待される変更**:
- foundry.tomlの設定
- ディレクトリ構造の作成（src/, test/, script/）
- 依存関係の設定
**テスト内容**: forge buildコマンドの実行確認

#### タスク2: インターフェース定義の実装
**背景**: コントラクト間の相互作用を定義
**問題点**: インターフェースが不明確だと統合が困難
**提案**: 明確な責任分離を持つインターフェース設計
**期待される変更**:
- IOracleAdapter.sol: 価格フィードのインターフェース
- ISettlementHook.sol: 約定処理のフック
- IOrderBook.sol: 注文板の基本操作
**テスト内容**: インターフェースのコンパイル確認

#### タスク3: 基本的なデータ構造の定義
**背景**: 効率的なデータ管理のための構造体定義
**問題点**: 不適切なデータ構造はガスコストを増大させる
**提案**: パッキングを考慮した最適化された構造体
**期待される変更**:
- MarketCfg: 市場設定パラメータ
- Order: 注文情報（双方向リンクリスト）
- Level: 価格レベルごとの注文集約
- BookState: 板の現在状態
**テスト内容**: 構造体のサイズとパッキングの検証

### フェーズ2: コア機能実装

#### タスク4: OrderBookMVPコントラクトの基本構造とストレージ
**背景**: メインコントラクトの骨格作成
**問題点**: ストレージレイアウトの最適化が必要
**提案**: 効率的なマッピングとstate変数の配置
**期待される変更**:
- ストレージ変数の定義
- コンストラクタの実装
- 基本的な修飾子（onlyOwner, whenNotPaused）
**テスト内容**: デプロイとストレージの初期化テスト

#### タスク5: place関数の実装
**背景**: 新規注文の追加機能
**問題点**: 不正な注文によるスパム攻撃のリスク
**提案**: 複数のガード条件による検証
**期待される変更**:
- tick検証（価格の妥当性）
- minQty, minNotionalのチェック
- FIFOキューへの挿入
- bestBid/AskTickの更新
- OrderPlacedイベントの発行
**テスト内容**:
- 正常な注文追加
- ガード条件のテスト
- 最良価格の更新確認

#### タスク6: cancel関数の実装
**背景**: 注文取消機能
**問題点**: リンクリストの整合性を保つ必要がある
**提案**: 双方向リンクの適切な更新
**期待される変更**:
- 所有者検証
- 双方向リンクの更新
- totalQtyの減算
- 空レベルの処理と最良価格の更新
- OrderCancelledイベントの発行
**テスト内容**:
- 単一注文の取消
- 複数注文がある場合の取消
- 最良価格への影響テスト

#### タスク7: matchAtBest関数の実装
**背景**: 板の交差を解消する約定処理
**問題点**: DoS攻撃とガスリミットへの対応
**提案**: stepsMaxによる段階的約定
**期待される変更**:
- bestBid >= bestAskの判定
- bandチェック（価格乖離制限）
- FIFO原則での約定
- 部分約定の処理
- SettlementHookの呼び出し
- TradeMatchedイベントの発行
**テスト内容**:
- 完全約定のケース
- 部分約定のケース
- stepsMax制限のテスト
- band違反のケース

### フェーズ3: 補助機能実装

#### タスク8: ヘルパー関数の実装
**背景**: 共通処理の効率化
**問題点**: 重複コードによる保守性の低下
**提案**: 再利用可能なヘルパー関数
**期待される変更**:
- _nextLowerNonEmptyBid: 次の買い注文レベル探索
- _nextHigherNonEmptyAsk: 次の売り注文レベル探索
- _withinBand: 価格乖離チェック
- _fillLevelHead: レベル先頭の注文処理
**テスト内容**: 各ヘルパー関数の単体テスト

#### タスク9: View関数の実装
**背景**: 外部からの状態参照
**問題点**: ガス効率的な読み取り
**提案**: 最適化されたview関数
**期待される変更**:
- bestBidTick/bestAskTick取得
- levelOf: 特定価格レベルの情報
- orderOf: 特定注文の情報
- getOpenOrders: トレーダーの未約定注文
**テスト内容**: 各view関数の動作確認

#### タスク10: アクセス制御とパラメータ更新関数
**背景**: 運用時のパラメータ調整
**問題点**: 不正な変更の防止
**提案**: 適切な権限管理
**期待される変更**:
- setMinQty/setMinNotional
- setDeviationLimit
- setSettlementHook
- pause/unpause機能
- ParamsUpdatedイベント
**テスト内容**: 権限チェックとパラメータ更新の検証

### フェーズ4: モックとフック実装

#### タスク11: MockOracleAdapterの実装
**背景**: テスト用の価格フィード
**問題点**: 実際のOracleなしでのテスト
**提案**: 設定可能な価格を返すモック
**期待される変更**:
- indexPrice/markPrice関数
- 価格設定関数
- 価格操作のシミュレーション
**テスト内容**: 価格設定と取得のテスト

#### タスク12: BasicSettlementHookの実装
**背景**: 約定後の処理フック
**問題点**: 将来の拡張性を確保
**提案**: 基本的な約定記録と通知
**期待される変更**:
- onMatch関数の実装
- 約定情報の記録
- 基本的な検証ロジック
**テスト内容**: フック呼び出しと記録の確認

### フェーズ5: テスト実装

#### タスク13: 基本的な単体テスト
**背景**: 各機能の個別検証
**問題点**: バグの早期発見
**提案**: 網羅的な単体テスト
**期待される変更**:
- OrderBookPlace.t.sol: place機能のテスト
- OrderBookCancel.t.sol: cancel機能のテスト
- OrderBookMatch.t.sol: 基本的なマッチングテスト
**テスト内容**: 正常系と異常系の網羅

#### タスク14: エッジケーステスト
**背景**: 境界条件での動作確認
**問題点**: 予期しない動作の防止
**提案**: 極端なケースのテスト
**期待される変更**:
- 部分約定の複雑なケース
- 全約定での状態遷移
- stepsMax制限の境界値
- 空の板での操作
**テスト内容**: エッジケースの網羅的テスト

#### タスク15: ガード機能のテスト
**背景**: 不正な注文の防止
**問題点**: スパム攻撃への対策
**提案**: 各ガード条件の検証
**期待される変更**:
- minQty違反のテスト
- minNotional違反のテスト
- deviationLimit違反のテスト
- 複合条件のテスト
**テスト内容**: 各ガード条件の境界値テスト

#### タスク16: 最良価格更新ロジックのテスト
**背景**: 板の整合性維持
**問題点**: 複雑な状態遷移
**提案**: 様々なシナリオでのテスト
**期待される変更**:
- 新規注文による更新
- 取消による更新
- 約定による更新
- 空レベルの処理
**テスト内容**: 最良価格の追跡と検証

#### タスク17: Settlement Hook統合テスト
**背景**: 外部連携の検証
**問題点**: Hook呼び出しの信頼性
**提案**: 統合シナリオのテスト
**期待される変更**:
- Hook設定と解除
- 約定時のHook呼び出し
- エラーハンドリング
- ガス使用量の測定
**テスト内容**: Hook連携の完全性テスト

### フェーズ6: 最適化とセキュリティ

#### タスク18: ガス使用量の計測テスト
**背景**: コスト効率の検証
**問題点**: 高いガスコストは実用性を損なう
**提案**: ベンチマークテストの実装
**期待される変更**:
- GasBenchmark.t.sol
- 大規模注文のガス測定
- マッチングのガス測定
- 最悪ケースの分析
**テスト内容**: 各操作のガスコスト測定と最適化

#### タスク19: セキュリティテスト
**背景**: 攻撃への耐性確認
**問題点**: 脆弱性の存在
**提案**: セキュリティ監査テスト
**期待される変更**:
- Reentrancy攻撃のテスト
- アクセス制御のテスト
- オーバーフロー/アンダーフローテスト
- DoS攻撃シミュレーション
**テスト内容**: 各種攻撃ベクトルの検証

#### タスク20: 統合テストとドキュメント作成
**背景**: 全体の動作確認と文書化
**問題点**: 複雑な相互作用の検証
**提案**: エンドツーエンドテストと詳細文書
**期待される変更**:
- OrderBookIntegration.t.sol
- 実際の取引フローシミュレーション
- README.mdの作成
- デプロイスクリプト
**テスト内容**: 完全な取引ライフサイクルのテスト

## 成功基準

1. **機能要件**
   - すべての基本操作（place, cancel, match）が正常動作
   - FIFO原則の遵守
   - 価格優先の実装

2. **非機能要件**
   - ガス使用量がO(1)に近い
   - DoS攻撃への耐性
   - 100%のテストカバレッジ

3. **拡張性**
   - Settlement Hookによる将来拡張
   - パラメータの動的更新
   - アップグレード可能な設計

## リスクと対策

| リスク | 影響度 | 対策 |
|-------|--------|------|
| DoS攻撃 | 高 | stepsMaxによる制限 |
| ガスリミット超過 | 高 | 段階的約定の実装 |
| 価格操作 | 高 | deviationLimitチェック |
| Reentrancy | 中 | nonReentrant修飾子 |
| 不正な注文 | 中 | minQty/minNotionalガード |

## スケジュール目安

- フェーズ1（基盤構築）: 1日
- フェーズ2（コア機能）: 2-3日
- フェーズ3（補助機能）: 1日
- フェーズ4（モック実装）: 1日
- フェーズ5（テスト実装）: 2-3日
- フェーズ6（最適化）: 1-2日

合計: 約8-12日

## 参考資料
- spec_mini_mvp.md: MVP仕様書
- spec.md: 完全版仕様書
- Foundryドキュメント: https://book.getfoundry.sh/